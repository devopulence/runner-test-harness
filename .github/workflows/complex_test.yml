name: Complex Performance Test

on:
  workflow_dispatch:
    inputs:
      test_id:
        description: 'Unique test identifier'
        required: true
        type: string
      parallel_jobs:
        description: 'Number of parallel jobs'
        required: false
        default: '3'
        type: string
      iterations:
        description: 'Number of iterations per job'
        required: false
        default: '10'
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    name: Setup - ${{ inputs.test_id }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      timestamp: ${{ steps.set-timestamp.outputs.timestamp }}

    steps:
      - name: üìù Initialize Test
        run: |
          echo "Complex test initialization"
          echo "Test ID: ${{ inputs.test_id }}"
          echo "Parallel jobs: ${{ inputs.parallel_jobs }}"
          echo "Iterations: ${{ inputs.iterations }}"

      - name: üî¢ Generate Job Matrix
        id: set-matrix
        run: |
          matrix=$(seq 1 ${{ inputs.parallel_jobs }} | jq -R . | jq -s -c .)
          echo "matrix=${matrix}" >> $GITHUB_OUTPUT
          echo "Generated matrix for ${{ inputs.parallel_jobs }} jobs"

      - name: ‚è∞ Set Timestamp
        id: set-timestamp
        run: |
          timestamp=$(date -u +%Y%m%d%H%M%S)
          echo "timestamp=${timestamp}" >> $GITHUB_OUTPUT

  parallel-processing:
    needs: setup
    runs-on: ubuntu-latest
    name: Process Job ${{ matrix.job_id }}
    strategy:
      matrix:
        job_id: ${{ fromJson(needs.setup.outputs.matrix) }}
      max-parallel: 10

    steps:
      - name: üìù Start Parallel Job
        run: |
          echo "Starting job ${{ matrix.job_id }} of ${{ inputs.parallel_jobs }}"
          echo "JOB_START=$(date +%s)" >> $GITHUB_ENV

      - name: üõ†Ô∏è Setup Environment
        run: |
          echo "Setting up job environment..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq bc stress-ng sysbench > /dev/null 2>&1

      - name: üîÑ CPU Intensive Task
        run: |
          echo "Running CPU intensive operations..."

          # Mathematical computations
          for i in $(seq 1 ${{ inputs.iterations }}); do
            echo "Iteration $i/${{ inputs.iterations }} (Job ${{ matrix.job_id }})"

            # Calculate pi to 1000 digits
            echo "scale=1000; 4*a(1)" | bc -l > /dev/null

            # Prime number generation
            sysbench --test=cpu --cpu-max-prime=10000 run > /dev/null 2>&1

            # Sleep briefly
            sleep 1
          done

      - name: üíæ Memory Operations
        run: |
          echo "Testing memory operations..."

          # Allocate and deallocate memory
          stress-ng --vm 1 --vm-bytes 256M --timeout 10s --metrics-brief 2>&1 | tail -5

      - name: üìÅ I/O Operations
        run: |
          echo "Performing I/O operations..."

          # Create multiple files
          mkdir -p test_dir_${{ matrix.job_id }}
          cd test_dir_${{ matrix.job_id }}

          for i in $(seq 1 20); do
            dd if=/dev/urandom of=file_${i}.dat bs=1M count=5 2>/dev/null
          done

          # File operations
          find . -type f -exec sha256sum {} \; > ../checksums_${{ matrix.job_id }}.txt
          tar czf ../archive_${{ matrix.job_id }}.tar.gz .

          cd ..
          echo "Created archive: $(ls -lh archive_${{ matrix.job_id }}.tar.gz | awk '{print $5}')"

      - name: üåê Network Load Simulation
        run: |
          echo "Simulating network load..."

          # Multiple concurrent curl requests
          for i in $(seq 1 5); do
            curl -s -o /dev/null -w "Request $i: %{http_code} - %{time_total}s\n" \
              https://httpbin.org/delay/1 &
          done
          wait

      - name: üìä Generate Job Report
        run: |
          JOB_END=$(date +%s)
          JOB_DURATION=$((JOB_END - JOB_START))

          cat << EOF > job_report_${{ matrix.job_id }}.json
          {
            "job_id": ${{ matrix.job_id }},
            "test_id": "${{ inputs.test_id }}",
            "iterations": ${{ inputs.iterations }},
            "duration_seconds": ${JOB_DURATION},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "completed"
          }
          EOF

          cat job_report_${{ matrix.job_id }}.json

      - name: üì§ Upload Job Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: job-${{ matrix.job_id }}-results-${{ inputs.test_id }}
          path: |
            job_report_${{ matrix.job_id }}.json
            checksums_${{ matrix.job_id }}.txt
            archive_${{ matrix.job_id }}.tar.gz

  aggregate-results:
    needs: [setup, parallel-processing]
    runs-on: ubuntu-latest
    name: Aggregate Results - ${{ inputs.test_id }}

    steps:
      - name: üì• Download All Artifacts
        uses: actions/download-artifact@v3
        with:
          pattern: job-*-results-${{ inputs.test_id }}
          merge-multiple: true

      - name: üîÑ Process Results
        run: |
          echo "Aggregating results from all parallel jobs..."

          # Count successful jobs
          SUCCESS_COUNT=$(ls -1 job_report_*.json | wc -l)
          echo "Successful jobs: ${SUCCESS_COUNT}/${{ inputs.parallel_jobs }}"

          # Combine all reports
          jq -s '.' job_report_*.json > combined_report.json

          # Calculate total duration
          TOTAL_DURATION=$(jq '[.[].duration_seconds] | add' combined_report.json)
          AVG_DURATION=$(jq '[.[].duration_seconds] | add / length' combined_report.json)

          echo "Total processing time: ${TOTAL_DURATION} seconds"
          echo "Average job duration: ${AVG_DURATION} seconds"

      - name: üìä Generate Final Report
        run: |
          cat << EOF > final_report.json
          {
            "test_id": "${{ inputs.test_id }}",
            "test_type": "complex",
            "configuration": {
              "parallel_jobs": ${{ inputs.parallel_jobs }},
              "iterations_per_job": ${{ inputs.iterations }}
            },
            "results": {
              "successful_jobs": $(ls -1 job_report_*.json | wc -l),
              "total_jobs": ${{ inputs.parallel_jobs }},
              "total_duration": $(jq '[.[].duration_seconds] | add' combined_report.json),
              "average_duration": $(jq '[.[].duration_seconds] | add / length' combined_report.json)
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "===== FINAL REPORT ====="
          cat final_report.json | jq '.'

      - name: üì§ Upload Final Report
        uses: actions/upload-artifact@v3
        with:
          name: final-report-${{ inputs.test_id }}
          path: |
            final_report.json
            combined_report.json

      - name: ‚úÖ Test Complete
        run: |
          echo "========================================="
          echo "COMPLEX TEST COMPLETED SUCCESSFULLY"
          echo "========================================="
          echo "Test ID: ${{ inputs.test_id }}"
          echo "Parallel Jobs: ${{ inputs.parallel_jobs }}"
          echo "Iterations: ${{ inputs.iterations }}"
          echo "Status: SUCCESS"
          echo "========================================="