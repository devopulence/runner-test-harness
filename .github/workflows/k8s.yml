
name: k8s

on:
  push:
    branches:
      - dind-test
  pull_request:
  workflow_dispatch:
    inputs:
      workload_type:
        description: 'Workload type for performance testing'
        required: false
        default: 'standard'
        type: choice
        options:
          - test
          - light
          - standard
          - heavy
      enable_randomization:
        description: 'Enable duration randomization'
        required: false
        default: 'true'
        type: boolean
      job_name:
        description: 'Job name for tracking (auto-generated by harness)'
        required: false
        default: ''
        type: string

jobs:
  k8s:
    runs-on: k8s
    steps:
      - uses: actions/checkout@v4
      - name: os-release
        run: |
         cat /etc/os-release
         pwd
      - name: podman
        run: |
         podman version
         podman info
      - name: Simulate workload
        run: |
          # Workload durations (seconds)
          # test: 30-60s, light: 120-180s, standard: 180-300s, heavy: 300-480s
          WORKLOAD_TYPE="${{ inputs.workload_type || 'standard' }}"
          ENABLE_RANDOM="${{ inputs.enable_randomization || 'true' }}"

          case "$WORKLOAD_TYPE" in
            test)     BASE=45;  VARIANCE=15 ;;
            light)    BASE=150; VARIANCE=30 ;;
            standard) BASE=240; VARIANCE=60 ;;
            heavy)    BASE=390; VARIANCE=90 ;;
            *)        BASE=240; VARIANCE=60 ;;
          esac

          if [ "$ENABLE_RANDOM" = "true" ]; then
            # Add randomization: BASE +/- VARIANCE/2
            RANDOM_OFFSET=$((RANDOM % VARIANCE - VARIANCE / 2))
            DURATION=$((BASE + RANDOM_OFFSET))
          else
            DURATION=$BASE
          fi

          echo "Workload: $WORKLOAD_TYPE"
          echo "Duration: ${DURATION}s"
          echo "Job: ${{ inputs.job_name || 'manual' }}"
          sleep $DURATION
  ci:
    uses: xxx-actions/workflows/.github/workflows/reusable-workflow.yml@main
    with:
      mnemonic: ghe
      build-type: npm
      node-version: 20
      #docker-image: true
    secrets: inherit

